<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>sdns: sdns</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="customDoxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">sdns
   </div>
   <div id="projectbrief">low-level DNS library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">sdns </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="md_Tutorials_2main"></a> Welcome to <b>sdns</b> documentation! Here I explain how to use the library and how to create/manipulate a DNS packet.</p>
<p>To work with DNS packets, one should both have the knowledge of the APIs (this library and this tutorial) as well as the DNS structure. If you don't know how DNS works in general, this tutorial is not for you! You must know the general structure of a DNS packet (<a href="https://datatracker.ietf.org/doc/html/rfc1035">RFC1035</a>) as well as some knowledge of DNS resolvers.</p>
<p>I tried to document all the APIs but I can not explain the whole DNS concept in the documentation. First, I explain the concept of the library and then we go through three tutorials (step by step) and create some applications using the library.</p>
<blockquote class="doxtable">
<p>&zwj;[NOTE] You can also directly jump into the practical tutorials/projects </p>
</blockquote>
<ul>
<li><a class="el" href="md_Tutorials_2tutorial__1.html">First tutorial</a>: Creating a naive dig command-line tool using sdns library.</li>
<li><a class="el" href="md_Tutorials_2tutorial__2.html">Second tutorial</a>: Creating a DNS packet sniffer (naive-wireshark for DNS)</li>
</ul>
<h4><a class="anchor" id="autotoc_md0"></a>
General concept</h4>
<p>Working with the library, everything is about DNS context, an instance of the C structure <a class="el" href="structsdns__context.html">sdns_context</a> that is created by calling <a class="el" href="sdns_8h.html#a9a4ce8ee39d593289f8fbacb74eb6456" title="Initialize and create a new DNS context.">sdns_init_context()</a> function. This context (we call it DNS context), contains all the information about the DNS packet we are making or the DNS packet we received from the socket. Depending on what we want to do (making a DNS packet or parsing a received data from the socket), we have the following steps:</p>
<ul>
<li>We want to make a DNS packet and send it through UDP (or TCP) socket.<ol type="1">
<li>We have to create a new DNS context by calling <a class="el" href="sdns_8h.html#a9a4ce8ee39d593289f8fbacb74eb6456" title="Initialize and create a new DNS context.">sdns_init_context()</a> function.</li>
<li>Passing the created context to several functions like <a class="el" href="sdns_8h.html#a7d89c4af9c34829f4503a21804cd0917" title="Creates a DNS question query.">sdns_make_query()</a>, <a class="el" href="sdns_8h.html#a63ba43dba7d2bfd1323f46be04d026da" title="Creates an answer section for the DNS packet.">sdns_add_answer_section()</a>, ... based on the packet we want to build.</li>
<li>Passing the context to <a class="el" href="sdns_8h.html#a0bbda400d5feff806b4ae1f9f2031a0b" title="Coverts a DNS context to binary format.">sdns_to_wire()</a> function to convert the context to wire format (a sequence of bytes ready for the socket).</li>
<li>Sending whatever that is inside the <b>raw</b> field of the context structure to the socket.</li>
<li>Free the created context by calling <a class="el" href="sdns_8h.html#a2d394cf61dcbd6b62aea1e8ecee1e514" title="Frees the context allocated by sdns_init_context().">sdns_free_context()</a> function.</li>
</ol>
</li>
</ul>
<p>Or</p>
<ul>
<li>We have received a sequence of bytes from the socket and we want to parse it to get a DNS structure.<ol type="1">
<li>We create a DNS context by calling <a class="el" href="sdns_8h.html#a9a4ce8ee39d593289f8fbacb74eb6456" title="Initialize and create a new DNS context.">sdns_init_context()</a> function.</li>
<li>Set the <b>raw</b> field of the context to the data buffer we received from the socket (and also set the <b>raw_len</b> field to the length of the buffer).</li>
<li>Pass the DNS context to <a class="el" href="sdns_8h.html#af49cd2767c9b38bd2f8f15ac0a9ced60" title="Converts the raw data received from socket (bytes) to a DNS packet.">sdns_from_wire()</a> function to parse the binary data to a DNS packet.</li>
<li>Do whatever you want with the parsed data.</li>
<li>Free the created context by calling <a class="el" href="sdns_8h.html#a2d394cf61dcbd6b62aea1e8ecee1e514" title="Frees the context allocated by sdns_init_context().">sdns_free_context()</a> function.</li>
</ol>
</li>
</ul>
<p>Let's see a very small example of how we can do the above-mentioned steps.</p>
<p>We want to create a DNS packet, asking about the <code>A</code> record of <code>google.com</code>. This packet has one question section only.</p>
<p>Using <a href="https://linux.die.net/man/1/dig">Dig</a>, here is the command to create this packet:</p>
<div class="fragment"><div class="line"># +noedns tells dig not to add edns0 support.</div>
<div class="line"># So additional section will be empty and we only have 1 question in question section.</div>
<div class="line"> </div>
<div class="line">dig google.com IN A +noedns</div>
</div><!-- fragment --><p>Now let's see how we can make it using sdns library:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &lt;assert.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="sdns_8h.html">sdns.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main(){</div>
<div class="line">    <a class="code hl_struct" href="structsdns__context.html">sdns_context</a> * dnsctx = <a class="code hl_function" href="sdns_8h.html#a9a4ce8ee39d593289f8fbacb74eb6456">sdns_init_context</a>();</div>
<div class="line">    <span class="keywordflow">if</span> (NULL == dnsctx){    <span class="comment">// we are done as we can create the context</span></div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Can not create a DNS context\n&quot;</span>);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordtype">char</span> * qname = strdup(<span class="stringliteral">&quot;google.com&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> res = <a class="code hl_function" href="sdns_8h.html#a7d89c4af9c34829f4503a21804cd0917">sdns_make_query</a>(dnsctx, <a class="code hl_enumvalue" href="sdns_8h.html#abc5aca5cb71471685dd6f7f66aae28e3ab7bff52804c24a581f5518e304207ee0">sdns_rr_type_A</a>, <a class="code hl_enumvalue" href="sdns_8h.html#a234b54d3d209541e1abe627bd485161da5cbe3170cb87b36e22649a80c55675c4">sdns_q_class_IN</a>, qname, 0);</div>
<div class="line">    <span class="keywordflow">if</span> (res != 0){  </div>
<div class="line">        <span class="comment">// sdns_make_query() failed. The return value can tell us why.</span></div>
<div class="line">        <span class="comment">// we have to call sdns_error_string() with &#39;res&#39; to know the reason.</span></div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Can not create the query packet\n&quot;</span>);</div>
<div class="line">        <a class="code hl_function" href="sdns_8h.html#a2d394cf61dcbd6b62aea1e8ecee1e514">sdns_free_context</a>(dnsctx);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// we are done. Now if we want to get the binary data to send it over the socket</span></div>
<div class="line">    <span class="comment">// we have to call sdns_to_wire() function.</span></div>
<div class="line">    res = <a class="code hl_function" href="sdns_8h.html#a0bbda400d5feff806b4ae1f9f2031a0b">sdns_to_wire</a>(dnsctx);</div>
<div class="line">    <span class="keywordflow">if</span> (res != 0){</div>
<div class="line">        fprintf(stderr, <span class="stringliteral">&quot;Can not covert to binary data\n&quot;</span>);</div>
<div class="line">        <a class="code hl_function" href="sdns_8h.html#a2d394cf61dcbd6b62aea1e8ecee1e514">sdns_free_context</a>(dnsctx);</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="comment">// let&#39;s print the hex presentation of the data</span></div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;Raw data ready for the socket:\n&quot;</span>);</div>
<div class="line">    <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i=0; i &lt; dnsctx-&gt;<a class="code hl_variable" href="structsdns__context.html#a56974606d7845a1e3d89084d1af8c68e">raw_len</a>; ++i){</div>
<div class="line">        fprintf(stdout, <span class="stringliteral">&quot;%02x &quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)dnsctx-&gt;<a class="code hl_variable" href="structsdns__context.html#abde5fc772131124fee72eb066298801f">raw</a>[i]);</div>
<div class="line">    }</div>
<div class="line">    fprintf(stdout, <span class="stringliteral">&quot;\n&quot;</span>);</div>
<div class="line">    <span class="comment">// let&#39;s free the context and we are done</span></div>
<div class="line">    <a class="code hl_function" href="sdns_8h.html#a2d394cf61dcbd6b62aea1e8ecee1e514">sdns_free_context</a>(dnsctx);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="asdns_8h_html"><div class="ttname"><a href="sdns_8h.html">sdns.h</a></div></div>
<div class="ttc" id="asdns_8h_html_a0bbda400d5feff806b4ae1f9f2031a0b"><div class="ttname"><a href="sdns_8h.html#a0bbda400d5feff806b4ae1f9f2031a0b">sdns_to_wire</a></div><div class="ttdeci">int sdns_to_wire(sdns_context *ctx)</div><div class="ttdoc">Coverts a DNS context to binary format.</div></div>
<div class="ttc" id="asdns_8h_html_a234b54d3d209541e1abe627bd485161da5cbe3170cb87b36e22649a80c55675c4"><div class="ttname"><a href="sdns_8h.html#a234b54d3d209541e1abe627bd485161da5cbe3170cb87b36e22649a80c55675c4">sdns_q_class_IN</a></div><div class="ttdeci">@ sdns_q_class_IN</div><div class="ttdoc">RFC1035 - the Internet.</div><div class="ttdef"><b>Definition</b> sdns.h:365</div></div>
<div class="ttc" id="asdns_8h_html_a2d394cf61dcbd6b62aea1e8ecee1e514"><div class="ttname"><a href="sdns_8h.html#a2d394cf61dcbd6b62aea1e8ecee1e514">sdns_free_context</a></div><div class="ttdeci">void sdns_free_context(sdns_context *ctx)</div><div class="ttdoc">Frees the context allocated by sdns_init_context().</div></div>
<div class="ttc" id="asdns_8h_html_a7d89c4af9c34829f4503a21804cd0917"><div class="ttname"><a href="sdns_8h.html#a7d89c4af9c34829f4503a21804cd0917">sdns_make_query</a></div><div class="ttdeci">int sdns_make_query(sdns_context *ctx, sdns_rr_type qtype, sdns_q_class cls, char *qname, int enable_edns0)</div><div class="ttdoc">Creates a DNS question query.</div></div>
<div class="ttc" id="asdns_8h_html_a9a4ce8ee39d593289f8fbacb74eb6456"><div class="ttname"><a href="sdns_8h.html#a9a4ce8ee39d593289f8fbacb74eb6456">sdns_init_context</a></div><div class="ttdeci">sdns_context * sdns_init_context(void)</div><div class="ttdoc">Initialize and create a new DNS context.</div></div>
<div class="ttc" id="asdns_8h_html_abc5aca5cb71471685dd6f7f66aae28e3ab7bff52804c24a581f5518e304207ee0"><div class="ttname"><a href="sdns_8h.html#abc5aca5cb71471685dd6f7f66aae28e3ab7bff52804c24a581f5518e304207ee0">sdns_rr_type_A</a></div><div class="ttdeci">@ sdns_rr_type_A</div><div class="ttdoc">RFC1035 - A record.</div><div class="ttdef"><b>Definition</b> sdns.h:229</div></div>
<div class="ttc" id="astructsdns__context_html"><div class="ttname"><a href="structsdns__context.html">sdns_context</a></div><div class="ttdef"><b>Definition</b> sdns.h:645</div></div>
<div class="ttc" id="astructsdns__context_html_a56974606d7845a1e3d89084d1af8c68e"><div class="ttname"><a href="structsdns__context.html#a56974606d7845a1e3d89084d1af8c68e">sdns_context::raw_len</a></div><div class="ttdeci">uint16_t raw_len</div><div class="ttdoc">Length of the raw data we received from socket.</div><div class="ttdef"><b>Definition</b> sdns.h:648</div></div>
<div class="ttc" id="astructsdns__context_html_abde5fc772131124fee72eb066298801f"><div class="ttname"><a href="structsdns__context.html#abde5fc772131124fee72eb066298801f">sdns_context::raw</a></div><div class="ttdeci">char * raw</div><div class="ttdoc">The raw bytes we received from socket.</div><div class="ttdef"><b>Definition</b> sdns.h:647</div></div>
</div><!-- fragment --><p>Copy and paste the following code into a file named 'minimain.c' and compile it manually by:</p>
<div class="fragment"><div class="line">gcc -g -I. sdns.c neat_print.c dns_utils.c dynamic_buffer.c minimain.c -o make_packet.o</div>
</div><!-- fragment --><p> After executing the file, you will have the following output:</p>
<div class="fragment"><div class="line">Raw data ready for the socket:</div>
<div class="line">b0 f2 01 00 00 01 00 00 00 00 00 00 06 67 6f 6f 67 6c 65 03 63 6f 6d 00 00 01 00 01</div>
</div><!-- fragment --><p>Now if we convert the binary data to a DNS packet using <a href="https://www.dnspython.org/">dnspython</a> package in Python:</p>
<div class="fragment"><div class="line"> 3</div>
<div class="line"><span class="comment"># python3 source code</span></div>
<div class="line"><span class="keyword">import</span> dns.message</div>
<div class="line">data = <span class="stringliteral">&quot;b0 f2 01 00 00 01 00 00 00 00 00 00 06 67 6f 6f 67 6c 65 03 63 6f 6d 00 00 01 00 01&quot;</span></div>
<div class="line">data = data.split()</div>
<div class="line">data = [int(x, 16) <span class="keywordflow">for</span> x <span class="keywordflow">in</span> data]</div>
<div class="line">print(dns.message.from_wire(bytes(data)))</div>
</div><!-- fragment --><p>Here is the output we get:</p>
<div class="fragment"><div class="line">id 45298</div>
<div class="line">opcode QUERY</div>
<div class="line">rcode NOERROR</div>
<div class="line">flags RD</div>
<div class="line">;QUESTION</div>
<div class="line">google.com. IN A</div>
<div class="line">;ANSWER</div>
<div class="line">;AUTHORITY</div>
<div class="line">;ADDITIONAL</div>
</div><!-- fragment --><p>Well, that's probably the easiest use case of the library! Still not as easy as Python but easy enough for C.</p>
<p>I have also provided a few tutorials to cover almost all the APIs of the library and show how to use them. In each tutorial, we try to make an easy application using sdns library and explain each step throughly. We try to avoid external libraries as much as possible to keep things clear and only focus on our APIs.</p>
<p><a class="el" href="md_Tutorials_2tutorial__1.html">Checkout the first tutorial</a>: In this tutorial, we are making a naive <a href="https://linux.die.net/man/1/dig">dig</a> using sdns library.</p>
<p><a class="el" href="md_Tutorials_2tutorial__2.html">The second tutorial</a>: Creating a DNS packet sniffer (naive-wireshark for DNS) </p>
</div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8
</small></address>
</body>
</html>
