#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sdns.h>
#include <sdns_print.h>
#include <sdns_json.h>
#include <time.h>
#include <assert.h>
/*
 * Tests different SOA packets.
 * compile and run:
 * gcc -g -Werror test_soa_1.c sdns.c sdns_dynamic_buffer.c sdns_utils.c -I. -o test && valgrind -s --leak-check=full ./test
 */

// list of test functions
int test1(void);
int test2(void);
int test3(void);
int test4(void);
int test5(void);
int test6(void);


int main(int argc, char ** argv){
    assert(test1() == 0);
    assert(test2() == 0);
    assert(test3() == 0);
    assert(test4() == 0);
    assert(test5() == 0);
    assert(test6() == 0);
    fprintf(stdout, "success\n");
    return 0;
}

int test1(){
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    // dig soa @1.1.1.1 google.com
    char packet_bytes[] = {
      0x96, 0xca, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x06, 0x67, 0x6f, 0x6f,
      0x67, 0x6c, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00,
      0x00, 0x06, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x06,
      0x00, 0x01, 0x00, 0x00, 0x00, 0x2c, 0x00, 0x26,
      0x03, 0x6e, 0x73, 0x31, 0xc0, 0x0c, 0x09, 0x64,
      0x6e, 0x73, 0x2d, 0x61, 0x64, 0x6d, 0x69, 0x6e,
      0xc0, 0x0c, 0x26, 0xdf, 0xe8, 0x03, 0x00, 0x00,
      0x03, 0x84, 0x00, 0x00, 0x03, 0x84, 0x00, 0x00,
      0x07, 0x08, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00,
      0x29, 0x04, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00
    };
    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    assert(sdns_from_wire(dns) == 0);
    sdns_rr_SOA * soa = sdns_decode_rr_SOA(dns, dns->msg->answer);
    assert(soa);
    assert(soa->expire == 1800);
    assert(soa->minimum == 60);
    assert(soa->retry == 900);
    assert(soa->refresh == 900);
    assert(soa->serial == 652208131);
    assert(strcmp(soa->rname, "dns-admin.google.com.") == 0);
    assert(strcmp(soa->mname, "ns1.google.com.") == 0);
    sdns_free_rr_SOA(soa);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}

int test2(){
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    // dig soa @1.1.1.1 gogole.com
    char packet_bytes[] = { // uses a different compression type from test1
      0x04, 0xbf, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x06, 0x67, 0x6f, 0x67,
      0x6f, 0x6c, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00,
      0x00, 0x06, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x06,
      0x00, 0x01, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x2d,
      0x03, 0x6e, 0x73, 0x31, 0x06, 0x67, 0x6f, 0x6f,
      0x67, 0x6c, 0x65, 0xc0, 0x13, 0x09, 0x64, 0x6e,
      0x73, 0x2d, 0x61, 0x64, 0x6d, 0x69, 0x6e, 0xc0,
      0x2c, 0x26, 0xdf, 0xe8, 0x03, 0x00, 0x00, 0x03,
      0x84, 0x00, 0x00, 0x03, 0x84, 0x00, 0x00, 0x07,
      0x08, 0x00, 0x00, 0x00, 0x3c, 0x00, 0x00, 0x29,
      0x04, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    assert(sdns_from_wire(dns) == 0);
    sdns_rr_SOA * soa = sdns_decode_rr_SOA(dns, dns->msg->answer);
    assert(soa);
    assert(soa->expire == 1800);
    assert(soa->minimum == 60);
    assert(soa->retry == 900);
    assert(soa->refresh == 900);
    assert(soa->serial == 652208131);
    assert(strcmp(soa->rname, "dns-admin.google.com.") == 0);
    assert(strcmp(soa->mname, "ns1.google.com.") == 0);
    sdns_free_rr_SOA(soa);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}

int test3(){
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    // dig soa @1.1.1.1 com
    char packet_bytes[] = {
      0x1b, 0xb2, 0x81, 0xa0, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x03, 0x63, 0x6f, 0x6d,
      0x00, 0x00, 0x06, 0x00, 0x01, 0xc0, 0x0c, 0x00,
      0x06, 0x00, 0x01, 0x00, 0x00, 0x02, 0x02, 0x00,
      0x3d, 0x01, 0x61, 0x0c, 0x67, 0x74, 0x6c, 0x64,
      0x2d, 0x73, 0x65, 0x72, 0x76, 0x65, 0x72, 0x73,
      0x03, 0x6e, 0x65, 0x74, 0x00, 0x05, 0x6e, 0x73,
      0x74, 0x6c, 0x64, 0x0c, 0x76, 0x65, 0x72, 0x69,
      0x73, 0x69, 0x67, 0x6e, 0x2d, 0x67, 0x72, 0x73,
      0xc0, 0x0c, 0x66, 0x95, 0x0f, 0x45, 0x00, 0x00,
      0x07, 0x08, 0x00, 0x00, 0x03, 0x84, 0x00, 0x09,
      0x3a, 0x80, 0x00, 0x01, 0x51, 0x80, 0x00, 0x00,
      0x29, 0x04, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00,
      0x00
    };
    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    assert(sdns_from_wire(dns) == 0);
    sdns_rr_SOA * soa = sdns_decode_rr_SOA(dns, dns->msg->answer);
    assert(soa);
    assert(soa->expire == 604800);
    assert(soa->minimum == 86400);
    assert(soa->retry == 900);
    assert(soa->refresh == 1800);
    assert(soa->serial == 1721044805);
    assert(strcmp(soa->rname, "nstld.verisign-grs.com.") == 0);
    assert(strcmp(soa->mname, "a.gtld-servers.net.") == 0);
    sdns_free_rr_SOA(soa);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}

int test4(){
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    // dig soa @1.1.1.1 .
    char packet_bytes[] = {
      0xd9, 0x78, 0x81, 0xa0, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x06, 0x00,
      0x01, 0x00, 0x00, 0x06, 0x00, 0x01, 0x00, 0x01,
      0x29, 0xac, 0x00, 0x40, 0x01, 0x61, 0x0c, 0x72,
      0x6f, 0x6f, 0x74, 0x2d, 0x73, 0x65, 0x72, 0x76,
      0x65, 0x72, 0x73, 0x03, 0x6e, 0x65, 0x74, 0x00,
      0x05, 0x6e, 0x73, 0x74, 0x6c, 0x64, 0x0c, 0x76,
      0x65, 0x72, 0x69, 0x73, 0x69, 0x67, 0x6e, 0x2d,
      0x67, 0x72, 0x73, 0x03, 0x63, 0x6f, 0x6d, 0x00,
      0x78, 0xa4, 0xe1, 0x4c, 0x00, 0x00, 0x07, 0x08,
      0x00, 0x00, 0x03, 0x84, 0x00, 0x09, 0x3a, 0x80,
      0x00, 0x01, 0x51, 0x80, 0x00, 0x00, 0x29, 0x04,
      0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    assert(sdns_from_wire(dns) == 0);
    sdns_rr_SOA * soa = sdns_decode_rr_SOA(dns, dns->msg->answer);
    assert(soa);
    assert(soa->expire == 604800);
    assert(soa->minimum == 86400);
    assert(soa->retry == 900);
    assert(soa->refresh == 1800);
    assert(soa->serial == 2024071500);
    assert(strcmp(soa->rname, "nstld.verisign-grs.com.") == 0);
    assert(strcmp(soa->mname, "a.root-servers.net.") == 0);
    sdns_free_rr_SOA(soa);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}

int test5(){
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    // dig soa @1.1.1.1 be
    char packet_bytes[] = {
      0x96, 0xf1, 0x81, 0xa0, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x02, 0x62, 0x65, 0x00,
      0x00, 0x06, 0x00, 0x01, 0xc0, 0x0c, 0x00, 0x06,
      0x00, 0x01, 0x00, 0x01, 0x51, 0x80, 0x00, 0x39,
      0x01, 0x61, 0x05, 0x6e, 0x73, 0x73, 0x65, 0x74,
      0xc0, 0x0c, 0x0d, 0x62, 0x65, 0x2d, 0x68, 0x6f,
      0x73, 0x74, 0x6d, 0x61, 0x73, 0x74, 0x65, 0x72,
      0x0a, 0x64, 0x6e, 0x73, 0x62, 0x65, 0x6c, 0x67,
      0x69, 0x75, 0x6d, 0xc0, 0x0c, 0x3d, 0x48, 0x3b,
      0x0d, 0x00, 0x00, 0x0e, 0x10, 0x00, 0x00, 0x07,
      0x08, 0x00, 0x24, 0xea, 0x00, 0x00, 0x00, 0x02,
      0x58, 0x00, 0x00, 0x29, 0x04, 0xd0, 0x00, 0x00,
      0x00, 0x00, 0x00, 0x20, 0x00, 0x0f, 0x00, 0x1c,
      0x00, 0x0a, 0x66, 0x6f, 0x72, 0x20, 0x44, 0x4e,
      0x53, 0x4b, 0x45, 0x59, 0x20, 0x62, 0x65, 0x2e,
      0x2c, 0x20, 0x69, 0x64, 0x20, 0x3d, 0x20, 0x31,
      0x32, 0x36, 0x36, 0x34
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    assert(sdns_from_wire(dns) == 0);
    sdns_rr_SOA * soa = sdns_decode_rr_SOA(dns, dns->msg->answer);
    assert(soa);
    assert(soa->expire == 2419200);
    assert(soa->minimum == 600);
    assert(soa->retry == 1800);
    assert(soa->refresh == 3600);
    assert(soa->serial == 1028143885);
    assert(strcmp(soa->rname, "be-hostmaster.dnsbelgium.be.") == 0);
    assert(strcmp(soa->mname, "a.nsset.be.") == 0);
    sdns_free_rr_SOA(soa);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}

int test6(){
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    // dig soa @1.1.1.1 facbook.com
    char packet_bytes[] = {
      0xf1, 0xff, 0x81, 0x80, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x07, 0x66, 0x61, 0x63,
      0x62, 0x6f, 0x6f, 0x6b, 0x03, 0x63, 0x6f, 0x6d,
      0x00, 0x00, 0x06, 0x00, 0x01, 0xc0, 0x0c, 0x00,
      0x06, 0x00, 0x01, 0x00, 0x00, 0x0e, 0x10, 0x00,
      0x2a, 0x01, 0x61, 0x02, 0x6e, 0x73, 0x08, 0x66,
      0x61, 0x63, 0x65, 0x62, 0x6f, 0x6f, 0x6b, 0xc0,
      0x14, 0x03, 0x64, 0x6e, 0x73, 0xc0, 0x2e, 0xfa,
      0xce, 0xb0, 0x0c, 0x00, 0x00, 0x38, 0x40, 0x00,
      0x00, 0x07, 0x08, 0x00, 0x09, 0x3a, 0x80, 0x00,
      0x00, 0x0e, 0x10, 0x00, 0x00, 0x29, 0x04, 0xd0,
      0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    assert(sdns_from_wire(dns) == 0);
    sdns_rr_SOA * soa = sdns_decode_rr_SOA(dns, dns->msg->answer);
    assert(soa);
    assert(soa->expire == 604800);
    assert(soa->minimum == 3600);
    assert(soa->retry == 1800);
    assert(soa->refresh == 14400);
    assert(soa->serial == 4207849484);
    assert(strcmp(soa->rname, "dns.facebook.com.") == 0);
    assert(strcmp(soa->mname, "a.ns.facebook.com.") == 0);
    sdns_free_rr_SOA(soa);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}

