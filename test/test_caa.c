#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sdns.h>
#include <sdns_print.h>
#include <sdns_json.h>
#include <time.h>
#include <assert.h>
/*
 * Tests different SOA packets.
 * compile and run:
 * gcc -g -Werror test_caa.c ../src/sdns.c ../src/sdns_dynamic_buffer.c ../src/sdns_utils.c -I. -I../include -o test && valgrind -s --leak-check=full ./test
 */

// list of test functions
int test1(void);
int test2(void);
int test3(void);
int test4(void);

int main(int argc, char ** argv){
    assert(test1() == 0);
    assert(test2() == 0);
    assert(test3() == 0);
    assert(test4() == 0);
    fprintf(stdout, "success\n");
    return 0;
}

int test1(){
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    char packet_bytes[] = {
      0x8f, 0x72, 0x85, 0x00, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x0a, 0x66, 0x61, 0x6b,
      0x65, 0x64, 0x6f, 0x6d, 0x61, 0x69, 0x6e, 0x04,
      0x66, 0x61, 0x6b, 0x65, 0x00, 0x01, 0x01, 0x00,
      0x01, 0xc0, 0x0c, 0x01, 0x01, 0x00, 0x01, 0x00,
      0x00, 0x0e, 0x10, 0x00, 0x37, 0x01, 0x09, 0x69,
      0x73, 0x73, 0x75, 0x65, 0x77, 0x69, 0x6c, 0x64,
      0x66, 0x69, 0x6c, 0x6f, 0x76, 0x69, 0x72, 0x69,
      0x64, 0x2e, 0x63, 0x6f, 0x6d, 0x3b, 0x20, 0x6e,
      0x61, 0x6d, 0x65, 0x3d, 0x73, 0x6f, 0x75, 0x72,
      0x65, 0x6e, 0x61, 0x3b, 0x6c, 0x61, 0x73, 0x74,
      0x6e, 0x61, 0x6d, 0x65, 0x3d, 0x6d, 0x61, 0x72,
      0x6f, 0x6f, 0x66, 0x69, 0x00, 0x00, 0x29, 0x04,
      0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00,
      0x0a, 0x00, 0x18, 0x3f, 0xa4, 0x2a, 0x37, 0x9d,
      0xe7, 0x3a, 0xad, 0x01, 0x00, 0x00, 0x00, 0x66,
      0xbb, 0x48, 0x8b, 0x7d, 0x2e, 0x0a, 0xb2, 0xfd,
      0x4a, 0xc9, 0x26
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    assert(sdns_from_wire(dns) == 0);
    sdns_rr_CAA * caa = sdns_decode_rr_CAA(dns, dns->msg->answer);
    assert(caa);
    assert(caa->flag == 1);
    assert(caa->tag_len == 9);
    assert(caa->value_len == 44);
    assert(strncmp(caa->tag, "issuewild", caa->tag_len) == 0);
    assert(strncmp(caa->value, "filovirid.com; name=sourena;lastname=maroofi", caa->value_len) == 0);
    sdns_free_rr_CAA(caa);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
    /*
    */
}

int test2(){
    // this is exactly as test1 but the packet is malformed
    // just to make sure we don't have invalid memory read or crash
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    char packet_bytes[] = {     // we increase rdlength
      0x8f, 0x72, 0x85, 0x00, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x0a, 0x66, 0x61, 0x6b,
      0x65, 0x64, 0x6f, 0x6d, 0x61, 0x69, 0x6e, 0x04,
      0x66, 0x61, 0x6b, 0x65, 0x00, 0x01, 0x01, 0x00,
      0x01, 0xc0, 0x0c, 0x01, 0x01, 0x00, 0x01, 0x00,
      0x00, 0x0e, 0x10, 0x00, 0x38, 0x01, 0x09, 0x69, // 0x00, 0x37 -> 0x00, 0x38
      0x73, 0x73, 0x75, 0x65, 0x77, 0x69, 0x6c, 0x64,
      0x66, 0x69, 0x6c, 0x6f, 0x76, 0x69, 0x72, 0x69,
      0x64, 0x2e, 0x63, 0x6f, 0x6d, 0x3b, 0x20, 0x6e,
      0x61, 0x6d, 0x65, 0x3d, 0x73, 0x6f, 0x75, 0x72,
      0x65, 0x6e, 0x61, 0x3b, 0x6c, 0x61, 0x73, 0x74,
      0x6e, 0x61, 0x6d, 0x65, 0x3d, 0x6d, 0x61, 0x72,
      0x6f, 0x6f, 0x66, 0x69, 0x00, 0x00, 0x29, 0x04,
      0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00,
      0x0a, 0x00, 0x18, 0x3f, 0xa4, 0x2a, 0x37, 0x9d,
      0xe7, 0x3a, 0xad, 0x01, 0x00, 0x00, 0x00, 0x66,
      0xbb, 0x48, 0x8b, 0x7d, 0x2e, 0x0a, 0xb2, 0xfd,
      0x4a, 0xc9, 0x26
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    int res = sdns_from_wire(dns);
    assert(res == sdns_rcode_FormErr);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}


int test3(){
    // this is exactly as test1 but the packet is malformed
    // just to make sure we don't have invalid memory read or crash
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    char packet_bytes[] = {     // we increase rdlength
      0x8f, 0x72, 0x85, 0x00, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x0a, 0x66, 0x61, 0x6b,
      0x65, 0x64, 0x6f, 0x6d, 0x61, 0x69, 0x6e, 0x04,
      0x66, 0x61, 0x6b, 0x65, 0x00, 0x01, 0x01, 0x00,
      0x01, 0xc0, 0x0c, 0x01, 0x01, 0x00, 0x01, 0x00,
      0x00, 0x0e, 0x10, 0x00, 0x32, 0x01, 0x09, 0x69, // 0x00, 0x37 -> 0x00, 0x32
      0x73, 0x73, 0x75, 0x65, 0x77, 0x69, 0x6c, 0x64,
      0x66, 0x69, 0x6c, 0x6f, 0x76, 0x69, 0x72, 0x69,
      0x64, 0x2e, 0x63, 0x6f, 0x6d, 0x3b, 0x20, 0x6e,
      0x61, 0x6d, 0x65, 0x3d, 0x73, 0x6f, 0x75, 0x72,
      0x65, 0x6e, 0x61, 0x3b, 0x6c, 0x61, 0x73, 0x74,
      0x6e, 0x61, 0x6d, 0x65, 0x3d, 0x6d, 0x61, 0x72,
      0x6f, 0x6f, 0x66, 0x69, 0x00, 0x00, 0x29, 0x04,
      0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00,
      0x0a, 0x00, 0x18, 0x3f, 0xa4, 0x2a, 0x37, 0x9d,
      0xe7, 0x3a, 0xad, 0x01, 0x00, 0x00, 0x00, 0x66,
      0xbb, 0x48, 0x8b, 0x7d, 0x2e, 0x0a, 0xb2, 0xfd,
      0x4a, 0xc9, 0x26
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    int res = sdns_from_wire(dns);
    assert(res == sdns_rcode_FormErr);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}

int test4(){
    // this is exactly as test1 but the packet is malformed
    // just to make sure we don't have invalid memory read or crash
    sdns_context * dns = sdns_init_context();
    assert(dns != NULL);
    char packet_bytes[] = {     // we increase tag length
      0x8f, 0x72, 0x85, 0x00, 0x00, 0x01, 0x00, 0x01,
      0x00, 0x00, 0x00, 0x01, 0x0a, 0x66, 0x61, 0x6b,
      0x65, 0x64, 0x6f, 0x6d, 0x61, 0x69, 0x6e, 0x04,
      0x66, 0x61, 0x6b, 0x65, 0x00, 0x01, 0x01, 0x00,
      0x01, 0xc0, 0x0c, 0x01, 0x01, 0x00, 0x01, 0x00,
      0x00, 0x0e, 0x10, 0x00, 0x37, 0x01, 0xff, 0x69, // 0x09 -> 0xff
      0x73, 0x73, 0x75, 0x65, 0x77, 0x69, 0x6c, 0x64,
      0x66, 0x69, 0x6c, 0x6f, 0x76, 0x69, 0x72, 0x69,
      0x64, 0x2e, 0x63, 0x6f, 0x6d, 0x3b, 0x20, 0x6e,
      0x61, 0x6d, 0x65, 0x3d, 0x73, 0x6f, 0x75, 0x72,
      0x65, 0x6e, 0x61, 0x3b, 0x6c, 0x61, 0x73, 0x74,
      0x6e, 0x61, 0x6d, 0x65, 0x3d, 0x6d, 0x61, 0x72,
      0x6f, 0x6f, 0x66, 0x69, 0x00, 0x00, 0x29, 0x04,
      0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1c, 0x00,
      0x0a, 0x00, 0x18, 0x3f, 0xa4, 0x2a, 0x37, 0x9d,
      0xe7, 0x3a, 0xad, 0x01, 0x00, 0x00, 0x00, 0x66,
      0xbb, 0x48, 0x8b, 0x7d, 0x2e, 0x0a, 0xb2, 0xfd,
      0x4a, 0xc9, 0x26
    };

    dns->raw = packet_bytes;
    dns->raw_len = sizeof(packet_bytes);
    int res = sdns_from_wire(dns);
    assert(res == 0);
    sdns_rr_CAA * caa = sdns_decode_rr_CAA(dns, dns->msg->answer);
    assert(dns->err == SDNS_ERROR_RR_SECTION_MALFORMED);
    dns->raw = NULL;
    sdns_free_context(dns);
    return 0;
}
