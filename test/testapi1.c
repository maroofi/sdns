#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <sdns.h>
#include <sdns_api.h>
#include <sdns_utils.h>
#include <sdns_print.h>
#include <assert.h>

/**
 * This test create a query packet with NSID enabled.
 * we expect to receive the following bytes after converting to network format:
 * char packet_bytes[] = {
 *     0xb0, 0xf2, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x08, 0x75, 0x72, 0x6c,
 *     0x61, 0x62, 0x75, 0x73, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00,
 *     0x29, 0x04, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x03, 0x00, 0x00
 * }
 */



int main(){
    // create query and context
    sdns_context * dns = sdns_create_query("urlabuse.com", "A", "IN");
    assert(dns != NULL);
    
    // make it nsid aware
    assert(sdns_add_nsid(dns, NULL) == 0);
    int err = 0;
    int res = 0;
    uint16_t result_len = 0;
    char * buffer = sdns_to_network(dns, &err, &result_len);
    assert(err == 0);
    assert(buffer != NULL);
    //print_c_array(buffer, result_len);
    char expected[] = {
        0xb0, 0xf2, 0x01, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x08, 0x75, 0x72, 0x6c, 
        0x61, 0x62, 0x75, 0x73, 0x65, 0x03, 0x63, 0x6f, 0x6d, 0x00, 0x00, 0x01, 0x00, 0x01, 0x00, 0x00, 
        0x29, 0x04, 0xd0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04, 0x00, 0x03, 0x00, 0x00
    };
    assert(memcmp(expected, buffer, sizeof(expected)) == 0);
    free(buffer);
    sdns_free_context(dns);

    // this is a necessary since all the test files must have an output
    fprintf(stdout, "success\n");
    return 0;
}
